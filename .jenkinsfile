pipeline {
    agent {
        docker {
            image 'rust:latest'
        }
    }
     environment {
        GITHUB_CREDENTIALS_ID = 'GH Access Token'  // ID of the GitHub token created in Step 2
        REPO = 'TPatel82003/leet_code_rust' // GitHub repo in "org/repo" format
     }
    stages {
        stage('Check & Configure Setup') {
            steps {
                sh 'cargo install cargo-llvm-cov'
                sh 'rustc --version'
                sh 'cargo --version'
            }
        }
        stage('Checkout Branch') {
            steps {
                checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/TPatel82003/leet_code_rust']])
            }
        }
        stage('Build') {
            steps {
                githubCheck("Building", "Building Project")
                sh 'cargo build'
            }
        }
        stage('Unit Test') {
            steps {
                githubCheck("Unit Test")
                sh 'cargo llvm-cov --html'
            }
        }
        stage('Archive Coverage Report') {
            steps {
                archiveArtifacts artifacts: 'target/llvm-cov/html/**' , allowEmptyArchive: true
            }
        }
    }
     post {
        success {
            githubCheckStatus("Success")
        }
        failure {
            githubCheckStatus("Failure")
        }
     }
}def githubCheck(name, details) {
    githubCheckStatus('IN_PROGRESS', name, details)
}

def githubCheckStatus(status, name = 'Jenkins CI', details = '') {
    githubNotify credentialsId: env.GITHUB_CREDENTIALS_ID,
                 repo: env.REPO,
                 context: name,
                 status: status,
                 description: details
}
